services:

  neox-node:
    container_name: bridge-devnet-neox
    build:
      context: ./go-ethereum
      dockerfile: ../neox.Dockerfile
    ports:
      - 8562:8562
    command: [ "sh", "-c", "make RESTRICTED_NETWORK=0.0.0.0/0 privnet_start && tail -F ./privnet/single/node1/geth_node.log" ]

  neox-funding:
    container_name: bridge-devnet-neox-funding
    image: node:18-alpine
    depends_on:
      - neox-node
      - neon3-node
    volumes:
      - ./tools:/app/tools
      - ./tools/funding/neox-funding.csv:/app/neox-funding.csv
      - ./go-ethereum:/app/go-ethereum
    working_dir: /app/tools/funding
    environment:
      - NEOX_RPC_URL=http://neox-node:8562
    command: [
      "sh", "-c",
      "npm install && node fund-neox-accounts.js"
    ]
    restart: "no"

  neon3-node:
    container_name: bridge-devnet-neon3
    image: ghcr.io/axlabs/neo3-privatenet-docker/neo-cli-with-plugins:neo-node-3.7.5
    ports:
      - 40332:40332
    volumes:
      - ./neon3-config/config-consensus.privatenet3.json:/neo-cli/config.json:ro
      - ./neon3-config/wallet-consensus.privatenet3.json:/neo-cli/wallet.json:ro
      - ./neon3-config/rpcserver.config-consensus.json:/neo-cli/Plugins/RpcServer/RpcServer.json:ro
      - ./neon3-config/dbft.config-consensus.json:/neo-cli/Plugins/DBFTPlugin/DBFTPlugin.json:ro
      - ./neon3-config/applicationlogs.config-consensus.json:/neo-cli/Plugins/ApplicationLogs/ApplicationLogs.json:ro
      - ./neon3-config/tokentracker.config-consensus.json:/neo-cli/Plugins/TokensTracker/TokensTracker.json:ro
      - ./tools/run-neo-node.expect:/root/tools/run-neo-node.expect
    entrypoint: [
      "sh", "-c",
      "screen -dmS node expect -n /root/tools/run-neo-node.expect neo \"NM7Aky765FG8NhhwtxjXRx7jEL1cnw7PBP\" \"10000000\" && sleep 3 && tail --retry -f ./Logs/ConsensusService/*"
    ]

  #  RabbitMQ Management UI: http://localhost:15672 (login: admin/admin123)
  #  RabbitMQ AMQP: amqp://admin:admin123@localhost:5672
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: bridge-devnet-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
#    healthcheck:
#      test: ["CMD", "rabbitmq-diagnostics", "ping"]
#      interval: 30s
#      timeout: 10s
#      retries: 5
#      start_period: 30s

volumes:
  rabbitmq_data:
